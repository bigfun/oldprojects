<?php

class Products_Controller extends Controller
{   


	public function __construct()
    {
        parent::__construct();
        $this->template->title = "easyshop - Produkty";
    }
    public function index()
    {
        $this->view(0, 0);
    }

    public function view($method, $arguments)
    {


        $per_page = $this->input->get('limit', 5);
        $page_num = $this->input->get('page', 1);
        $offset = ($page_num-1)*$per_page;

        $query = ORM::factory('product');
        $products = $query->limit($per_page, $offset)->find_all();
        $pages = Pagination::factory( array
        (
        'style'=>'digg',
        'items_per_page'=>$per_page,
        'query_string'=>'page',
        'total_items'=>$query->count_last_query()
        ));

        $this->template->content = View::factory('products/view');
        $this->template->content->products = $products;
        $this->template->content->pages = $pages;

    }

    public function product($id)
    {
        $query = ORM::factory("product")->find($id);
        if ($query->count_last_query() < 1)
        {
            $this->template->title .= ' - nie znaleziono produktu';
            $this->template->content = View::factory('products/notexist');
        }
        else
        {
            $this->template->title .= ' - '.$query->title;
            $this->template->content = View::factory('products/product')->set('product', ORM::factory('product')->find($id));
        }
    }

    public function add()
    {

        if ($this->_user() != 'admin')
        {
            url::redirect();
            return;
        }
		$files = Validation::factory($_FILES)
		->add_rules('image', 'upload::valid', 'upload::type[gif,jpg,png]', 'upload::size[2M]');

        $_POST = Validation::factory($_POST)
        ->add_rules('title', 'required', 'length[1,250]')
        ->add_rules('description', 'required')
		->add_rules('price', 'required');
        if ($_POST->validate() and $files->validate())
        {   
			$filename = upload::save('image');
			Image::factory($filename)
			->resize(100, 100, Image::WIDTH)
			->save(DOCROOT.'media/pictures/'.basename($filename).'.jpg');

			unlink($filename);
            $product = ORM::factory('product');
            $product->title = $_POST['title'];
            $product->description = $_POST['description'];
			$product->price = $_POST['price'];
            $product->date = time();
			$product->image = DOCROOT.'media/pictures/'.basename($filename).'.jpg';
            $product->save();
            $this->session->set_flash('user_message', 'Dodano produkt do bazy danych');
            url::redirect('products/add');
        } else
        {
            $this->template->title .= ' - Dodaj nowy produkt';
            $this->template->content = View::factory('products/add');
        }
    }

    public function edit($id)
    {

        if ($this->_user() != 'admin')
        {
            url::redirect();
            return;
        }
        $article = ORM::factory('article')->find($id);
        if ($article->count_last_query() < 1)
        {
            $this->session->set_flash('user_message', 'Nie ma takiego newsa w bazie, dodajesz nowy.');
            url::redirect('articles/add');
        }
        else
        {


            $_POST = Validation::factory($_POST)
            ->add_rules('title', 'required', 'length[1,250]')
            ->add_rules('body', 'required');
            if ($_POST->validate())
            {
                $article = ORM::factory('article');
                $article->title = $_POST['title'];
                $article->body = $_POST['body'];
                $article->user_id = $this->session->get("id");
                $article->date = time();
                $article->save($id);
                $this->session->set_flash('user_message', 'Zapisano edycję do bazy danych');
                url::redirect('articles/article/'.$id);
            } else
            {
                $this->template->title .= ' - Edycja artykułu: '.$article->title;
                $this->template->content = View::factory('articles/edit')->set( array (
                'title_value'=>$article->title,
                'body_value'=>$article->body)
                );
            }
        }
    }

}
